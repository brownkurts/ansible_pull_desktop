\
    #!/usr/bin/env bash
    # Auto-generated by Ansible. Edits will be overwritten.

    APP_NAME="{{ item.name }}"
    SERVER="{{ item.server }}"
    APP_ALIAS="{{ item.app_alias }}"
    USERNAME="{{ item.username | default('') }}"
    DOMAIN="{{ item.domain | default('') }}"
    GATEWAY="{{ item.gateway | default('') }}"

    # Security: If you don't want passwords on disk, omit `password` in vars.
    # FreeRDP will prompt interactively. If you DO set a vaulted password, it will
    # be embedded below and file perms are 0700 to limit exposure.

    {% if item.password is defined and item.password|length > 0 %}
    PASSWORD="{{ item.password }}"
    {% else %}
    PASSWORD=""
    {% endif %}

    EXTRA_OPTS="{{ (item.extra_opts | default([])) | join(' ') }}"

    CMD=(xfreerdp /v:"$SERVER" /app:"{{ item.app_alias }}" /f /dynamic-resolution /cert:ignore /clipboard)

    # Username/Domain
    {% if item.domain is defined and item.domain|length > 0 and item.username is defined and item.username|length > 0 -%}
    CMD+=("/u:{{ item.username }}" "/d:{{ item.domain }}")
    {% elif item.username is defined and item.username|length > 0 -%}
    CMD+=("/u:{{ item.username }}")
    {% endif %}

    # Password (optional)
    {% if item.password is defined and item.password|length > 0 -%}
    CMD+=("/p:${PASSWORD}")
    {% endif %}

    # Gateway (optional)
    {% if item.gateway is defined and item.gateway|length > 0 -%}
    CMD+=("/g:{{ item.gateway }}")
    {% if item.gateway_domain is defined and item.gateway_domain|length > 0 -%}
    CMD+=("/gd:{{ item.gateway_domain }}")
    {% endif %}
    {% endif %}

    # Any extra freerdp flags
    if [[ -n "$EXTRA_OPTS" ]]; then
      # shellcheck disable=SC2206
      CMD+=($EXTRA_OPTS)
    fi

    exec "${CMD[@]}"
